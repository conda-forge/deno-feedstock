From 108d28e226cdc92e361b04a438635f4fa9c5f6a6 Mon Sep 17 00:00:00 2001
From: Michael Sarahan <msarahan@gmail.com>
Date: Tue, 6 Sep 2022 21:13:06 -0500
Subject: [PATCH 2/2] add system feature to libffi

---
 ext/ffi/Cargo.toml | 2 +-
 ext/ffi/build.rs   | 4 ++++
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/ext/ffi/Cargo.toml b/ext/ffi/Cargo.toml
index 05d417ad2..7763d2d83 100644
--- a/ext/ffi/Cargo.toml
+++ b/ext/ffi/Cargo.toml
@@ -19,7 +19,7 @@ autotools = "0.2"
 [dependencies]
 deno_core = { version = "0.148.0", path = "../../core" }
 dlopen = "0.1.8"
-libffi = "3.0.0"
+libffi = { version="3.0.1", features=["system"] }
 serde = { version = "1.0.129", features = ["derive"] }
 tokio = { version = "1.17", features = ["full"] }
 
diff --git a/ext/ffi/build.rs b/ext/ffi/build.rs
index fbdcbe58d..072324bd4 100644
--- a/ext/ffi/build.rs
+++ b/ext/ffi/build.rs
@@ -55,4 +55,8 @@ fn main() {
     build_tcc();
   }
   println!("cargo:rustc-link-lib=static=tcc");
+  if let Ok(build_prefix_path) = env::var("PREFIX") {
+    println!("cargo:rustc-link-search=native={}/lib", build_prefix_path);
+  }
+  println!("cargo:rustc-link-lib=ffi");
 }
-- 
2.34.1

