cross-build source bundling

From: Michael Ekstrand <mdekstrand@drexel.edu>


---
 cli/Cargo.toml |    5 +++--
 cli/ops/mod.rs |    5 +++++
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/cli/Cargo.toml b/cli/Cargo.toml
index 4e6fa01d5..79a0c33d9 100644
--- a/cli/Cargo.toml
+++ b/cli/Cargo.toml
@@ -30,6 +30,7 @@ path = "./bench/lsp_bench_standalone.rs"
 # A dev feature to disable creations and loading of snapshots in favor of
 # loading JS sources at runtime.
 __runtime_js_sources = ["deno_runtime/__runtime_js_sources"]
+snapshot = ["deno_core/include_js_files_for_snapshotting", "deno_runtime/include_js_files_for_snapshotting"]
 
 [build-dependencies]
 deno_runtime = { workspace = true, features = ["exclude_runtime_main_js", "include_js_files_for_snapshotting"] }
@@ -48,14 +49,14 @@ winres.workspace = true
 deno_ast = { workspace = true, features = ["bundler", "cjs", "codegen", "dep_graph", "module_specifier", "proposal", "react", "sourcemap", "transforms", "typescript", "view", "visit"] }
 deno_cache_dir = "=0.6.1"
 deno_config = "=0.5.0"
-deno_core = { workspace = true, features = ["include_js_files_for_snapshotting"] }
+deno_core = { workspace = true }
 deno_doc = { version = "=0.72.2", features = ["html"] }
 deno_emit = "=0.31.1"
 deno_graph = "=0.59.2"
 deno_lint = { version = "=0.52.2", features = ["docs"] }
 deno_lockfile.workspace = true
 deno_npm = "0.15.2"
-deno_runtime = { workspace = true, features = ["dont_create_runtime_snapshot", "exclude_runtime_main_js", "include_js_files_for_snapshotting"] }
+deno_runtime = { workspace = true, features = ["dont_create_runtime_snapshot", "exclude_runtime_main_js"] }
 deno_semver = "0.5.1"
 deno_task_shell = "=0.14.0"
 eszip = "=0.55.2"
diff --git a/cli/ops/mod.rs b/cli/ops/mod.rs
index eb75dc272..91a8eee29 100644
--- a/cli/ops/mod.rs
+++ b/cli/ops/mod.rs
@@ -41,6 +41,11 @@ deno_core::extension!(cli,
   customizer = |ext: &mut deno_core::Extension| {
     ext.esm_files.to_mut().push(deno_core::ExtensionFileSource {
       specifier: "ext:cli/runtime/js/99_main.js",
+      #[cfg(not(feature = "include_js_files_for_snapshotting"))]
+      code: deno_core::ExtensionFileSourceCode::IncludedInBinary(
+        deno_runtime::js::SOURCE_CODE_FOR_99_MAIN_JS,
+      ),
+      #[cfg(feature = "include_js_files_for_snapshotting")]
       code: deno_core::ExtensionFileSourceCode::LoadedFromFsDuringSnapshot(
         deno_runtime::js::PATH_FOR_99_MAIN_JS,
       ),
